<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>AppCountries</title>
    <base href="/" />
    <link href="css/bootstrap/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" crossorigin="anonymous">

    <link href="css/app.css" rel="stylesheet" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <link href="AppCountries.styles.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="_content/CurrieTechnologies.Razor.SweetAlert2/sweetAlert2.min.js" defer></script>
    <script type="module">// Importar Firebase desde las URL CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { setDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBFtaKGHFOhLKXUOkM6WjI6XfBOb8qLwCw",
            authDomain: "blazor-web-countries.firebaseapp.com",
            projectId: "blazor-web-countries",
            storageBucket: "blazor-web-countries.appspot.com",
            messagingSenderId: "9229473950",
            appId: "1:9229473950:web:0e74178b3ff81dd734838f"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app); // Inicializa Firestore

        // Función para iniciar sesión
        window.loginWithEmailPassword = async function (email, password) {
            console.log("Intentando iniciar sesión con:", email, password);
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                return JSON.stringify(userCredential.user);
            } catch (error) {
                console.error("Error de inicio de sesión:", error);
                return JSON.stringify({ error: error.code, message: error.message });
            }
        };

        // Función para registrar un nuevo usuario
        window.registerUser = async function (email, password, nombre, apellido, continente) {
            // Validaciones simples
            if (!email || !password || !nombre || !apellido || !continente) {
                return JSON.stringify({ error: 'Todos los campos son obligatorios.' });
            }
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                const usuarioData = {
                    Nombre: nombre,
                    Apellidos: apellido,
                    Continente: continente,
                    IsAdmin: false,
                    uid: user.uid // Cambié a "uid" en minúscula para mantener la consistencia
                };

                // Imprimir usuarioData en la consola
                console.log("Datos del usuario a guardar:", usuarioData);

                // Crear un documento con un ID específico (uid del usuario)
                await setDoc(doc(db, "Usuarios", user.uid), usuarioData);

                return JSON.stringify(user);
            } catch (error) {
                console.error("Error al registrar el usuario:", error); // Imprimir el error en la consola
                return JSON.stringify({ error: error.code, message: error.message });
            }
        };

        // Función para obtener un documento por ID
        window.getDocumentById = async function (documentId) {
            try {
                const docRef = doc(db, "Usuarios", documentId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    return JSON.stringify(docSnap.data());
                } else {
                    console.log("No se encontró el documento");
                    return JSON.stringify({ error: "No se encontró el documento" });
                }
            } catch (error) {
                console.error("Error al obtener el documento:", error);
                return JSON.stringify({ error: error.code, message: error.message });
            }
        };</script>
</head>

<body>
    <div id="app">
        <svg class="loading-progress">
            <circle r="40%" cx="50%" cy="50%" />
            <circle r="40%" cx="50%" cy="50%" />
        </svg>
        <div class="loading-progress-text"></div>
    </div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="" class="reload">Reload</a>
        <a class="dismiss">🗙</a>
    </div>
    <script src="_framework/blazor.webassembly.js"></script>


</body>

</html>